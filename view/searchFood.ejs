<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>what have you eat</title>
  <link rel="stylesheet" href="/css/searchFood.css"/>
</head>
<body>
  <div class="page">

    <!-- 左：记录饮食（购物车） -->
    <aside class="rail" aria-label="记录饮食侧栏">
      <form action="/searchCalories" method="get" class="row">
        <input  name="foodInput" class="search-input" placeholder="Search Food" required>
        <button type="submit" class="btn btn-primary">Search</button>
      </form>
      <h2 class="title">Food Record</h2>
      <div class="muted" style="margin-bottom:8px;">
        Total Calories Today：<strong style="font-size:22px;
    <% 
      const cal = typeof totalCalories !== 'undefined' ? totalCalories : 0;
      if (cal > 1300) { %>color:#ef4444;<% } 
      else if (cal >= 500) { %>color:#f59e0b;<% } 
      else { %>color:#10b981;<% }
    %>">
    <%= cal %> kcal
  </strong>
      </div>

      <div class="list">
        <% if (Array.isArray(eatenList) && eatenList.length > 0) { %>
          <% eatenList.forEach(item => { %>
            <div class="diet-item">
              <div>
                <p class="diet-name"><%= item.food_name %></p>
                <div class="muted">
                  <%= Number(item.calories) || 0 %> kcal/portion
                  · portion：<%= Number(item.quantity) || 1 %>
                  · sum：<%= (Number(item.calories)||0) * (Number(item.quantity)||1) %> kcal
                </div>
              </div>
              <form action="/eaten/remove" method="post">
                <input type="hidden" name="id" value="<%= item.id %>">
                <button type="submit" class="btn btn-danger">Delete</button>
              </form>
            </div>
          <% }) %>
        <% } else { %>
          <div class="diet-item" style="border-style:dashed;">
            <div>
              <p class="diet-name">Not record yet</p>
              
            </div>
          </div>
        <% } %>
      </div>

      <div class="row" style="margin-top:10px;">
        <a class="btn" href="/main">Home</a>
        <a class="btn" href="/newPost">Share</a>
      </div>
    </aside>

    
    

    <!-- 右：显示食物结果区域 -->
    <main class="result-list" aria-label="搜索结果">
      <% if (foodarray && foodarray.length != 0) { %>
        <% for (let i = 0; i < foodarray.length; i++) {
             const item = foodarray[i];
             const serving = Array.isArray(item.servings?.serving) ? item.servings.serving[0] : item.servings?.serving;
             const calories = serving?.calories || 0;
             const desc = serving?.serving_description || '';
        %>
          <div class="result">
            <div>
              <div style="font-weight:700"><%= item.food_name %></div>
              <div class="muted">Calories: <%= calories %> kcal · <%= desc %></div>
            </div>
            <form action="/eaten/add" method="post" class="row">
              <input type="hidden" name="food_name" value="<%= item.food_name %>">
              <input type="hidden" name="calories" value="<%= calories %>">
              <input type="hidden" name="serving_description" value="<%= desc %>">
              <label class="muted" for="qty-<%= i %>">Portion:</label>
              <input id="qty-<%= i %>" type="number" name="quantity" min="1" value="1">
              <button type="submit" class="btn btn-primary">Add</button>
            </form>
          </div>
        <% } %>
      <% } %>
    </main>

  </div>
</body>
<script src="/js/searchFood.js"></script>
</html>
