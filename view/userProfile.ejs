<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>User Profile - HealthyPal</title>
  <link rel="stylesheet" href="/css/userProfile.css"/>
</head>
<body>

  <div class="container">
    <nav class="nav">
      <div class="nav-left">
        <span class="brand">HealthyPal</span>
        <a href="/main" class="btn">Home</a>
      </div>
      <div class="nav-right">
        <a href="/editProfile" class="btn btn-primary">Edit Profile</a>
      </div>
    </nav>

    <% if (typeof success !== 'undefined' && success === 'updated') { %>
      <div class="alert-success">Profile updated successfully!</div>
    <% } %>

 
    <section class="profile-card">
      <img class="avatar" 
           src="<%= user.avatar ? user.avatar : 'data:image/svg+xml;utf8,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%22140%22 height=%22140%22><rect width=%22100%25%22 height=%22100%25%22 fill=%22%23e2e8f0%22/><text x=%2250%25%22 y=%2252%25%22 dominant-baseline=%22middle%22 text-anchor=%22middle%22 font-size=%2256%22 fill=%22%2364758b%22 font-family=%22sans-serif%22>%F0%9F%91%A4</text></svg>' %>" 
           alt="<%= user.username %>'s avatar">
      <div class="username"><%= user.username %></div>
      <p class="profile-bio"><%= user.profile ? user.profile : 'No profile description yet. Tell others about your fitness journey!' %></p>
    </section>


    <div class="main-grid">
      <section class="card">
        <h3>Personal Details</h3>
        <div class="info-grid">
          <strong>Username:</strong> <span><%= user.username %></span>
        </div>
        <div class="info-grid">
          <strong>Email:</strong> <span><%= user.email %></span>
        </div>
        <form method="POST" action="/delete">
        	<button type=submit class="delete-btn">Delete Account</button>
        </form>
        <% if (user.height || user.weight || user.gender || user.birthday || user.goal || user.TDEE || user.minimumIntake || user.maximumIntake) { %>
          <div style="margin-top: 10px; font-style: italic; color: var(--muted);">Body Information (only visible if set):</div>
          <% if (user.height) { %>
            <div class="info-grid">
              <strong>Height:</strong> <span><%= user.height + ' cm' %></span>
            </div>
          <% } %>
          <% if (user.weight) { %>
            <div class="info-grid">
              <strong>Weight:</strong> <span><%= user.weight + ' kg' %></span>
            </div>
          <% } %>
          <% if (user.gender) { %>
            <div class="info-grid">
              <strong>Gender:</strong> <span><%= user.gender %></span>
            </div>
          <% } %>
          <% if (user.birthday) { %>
            <div class="info-grid">
              <strong>Birthday:</strong> <span><%= new Date(user.birthday).toLocaleDateString() %></span>
            </div>
          <% } %>
          <% if (user.goal) { %>
            <div class="info-grid">
              <strong>Fitness Goal:</strong> <span><%= user.goal %></span>
            </div>
          <% } %>
          <% if (user.TDEE) { %>
            <div class="info-grid">
              <strong>Daily Calorie Target:</strong> <span><%= user.TDEE + ' kcal' %></span>
            </div>
          <% } %>
          <% if (user.minimumIntake && user.maximumIntake) { %>
            <div class="info-grid">
              <strong>Intake Range:</strong> <span><%= user.minimumIntake %> - <%= user.maximumIntake %> kcal</span>
            </div>
          <% } %>
        <% } %>
      </section>

      <section class="card calendar">
        <h3>Activity Calendar</h3>
        <div class="calendar-header">
          <div class="calendar-title"><%= new Date().toLocaleDateString('default', { month: 'long', year: 'numeric' }) %></div>
        </div>
        <div class="calendar-grid">
          <div class="dow">Sun</div><div class="dow">Mon</div><div class="dow">Tue</div><div class="dow">Wed</div><div class="dow">Thu</div><div class="dow">Fri</div><div class="dow">Sat</div>
          <%
            const today = new Date();
            const year = today.getFullYear();
            const month = today.getMonth();
            const firstDay = new Date(year, month, 1);
            const startDow = firstDay.getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const prevMonthDays = new Date(year, month, 0).getDate();
            const totalCells = 42; // 6 rows * 7 days
            for (let i = 0; i < totalCells; i++) {
              let dayNum, cls = 'day';
              if (i < startDow) {
                dayNum = prevMonthDays - startDow + 1 + i;
                cls += ' muted';
              } else if (i >= startDow + daysInMonth) {
                dayNum = i - (startDow + daysInMonth) + 1;
                cls += ' muted';
              } else {
                dayNum = i - startDow + 1;
                const isToday = (dayNum === today.getDate());
                if (isToday) cls += ' today';
              }
          %>
            <div class="<%= cls %>"><%= dayNum %></div>
          <% } %>
        </div>
      </section>
     
      
    </div>
    
     <section class="card postcard">
        <h3>Your Post</h3>
        <div class="user-post-list">
  <% if (posts && posts.length > 0) { %>
    <% posts.forEach(p => { %>

<div class="profile-post-card">

    <!-- 时间 -->
    <div class="post-time">
        <%= new Date(p.date).toLocaleString() %>
    </div>

    <!-- 内容区域 -->
    <div class="post-body">
        <div class="post-caption"><%= p.caption %></div>

        <% if (p.image) { %>
            <img src="<%= p.image %>" class="post-image">
        <% } %>

        <% if (p.totalCaloriesSnapshot !== undefined) { %>
            <div class="post-calories">
                <strong>Total calories: <%= p.totalCaloriesSnapshot %> kcal</strong>
            </div>
        <% } %>

        <!-- 删除按钮（你已有） -->
        <form action="/posts/<%= p._id %>/delete" method="POST">
            <button class="delete-btn">Delete</button>
        </form>
        <form action="/editPost/<%= p._id %>" method="get" style="display:inline;">
  <button type="submit" class="btn btn-primary">Update</button>
</form>
    </div>

</div>

    <% }) %>
<% } else { %>
    No post yet
<% } %>
</div>
      </section>
      
  </div>

</body>
</html>
